# SWE-smith 数据集使用分析

## 项目概述

SWE-smith 是一个用于训练软件工程代理（SWE-agents）的工具包，可以将任何 GitHub 仓库转换为 SWE-gym 环境，并创建无限的任务实例用于训练。

## 数据集来源

### 1. HuggingFace 数据集
- **主要数据集**: `SWE-bench/SWE-smith`
- **规模**: 52,000+ 任务实例
- **访问方式**: 通过 `datasets` 库加载

```python
from datasets import load_dataset
ds = load_dataset("SWE-bench/SWE-smith", split="train")
```

### 2. 本地数据集文件
- **格式**: JSON 或 JSONL
- **路径**: 可以是本地文件路径
- **使用场景**: 自定义子集、本地生成的实例

## 数据集实例结构

每个数据集实例（task instance）是一个字典，包含以下字段：

### 必需字段

```python
{
    "instance_id": str,          # 唯一标识符，格式: owner__repo.commit_hash
    "repo": str,                 # 仓库名称（mirror名称）
    "patch": str,                # 修复补丁（diff格式），应用后修复bug
    "FAIL_TO_PASS": list[str],   # 失败的测试用例列表（应用bug后失败，修复后通过）
    "PASS_TO_PASS": list[str],   # 通过的测试用例列表（应用bug前后都通过）
    "image_name": str,           # Docker镜像名称，用于执行环境
}
```

### 可选字段

```python
{
    "problem_statement": str,    # 问题描述文本
    "test_patch": str,           # 测试补丁（PR镜像方法生成）
    "base_commit": str,          # 基础提交SHA
    "pull_number": int,          # PR编号（如果是PR镜像生成）
    "instance_ref": dict,        # 实例引用信息（包含test_patch等）
    "hints_text": str,           # 提示文本
    "created_at": str,           # 创建时间
    "version": str,              # 版本信息
}
```

## 数据集使用流程

### 1. 加载数据集

#### 从 HuggingFace 加载
```python
from datasets import load_dataset
from swesmith.constants import HF_DATASET

# 加载完整数据集
dataset = load_dataset(HF_DATASET, split="train")  # HF_DATASET = "SWE-bench/SWE-smith"

# 转换为列表
dataset_list = [x for x in dataset]
```

#### 从本地文件加载
```python
import json
from pathlib import Path

# JSON格式
with open("path/to/dataset.json") as f:
    dataset = json.load(f)

# JSONL格式
dataset = []
with open("path/to/dataset.jsonl") as f:
    for line in f:
        dataset.append(json.loads(line))
```

### 2. 获取仓库配置（RepoProfile）

```python
from swesmith.profiles import registry

# 从实例获取对应的RepoProfile
for task in dataset:
    rp = registry.get_from_inst(task)  # 根据instance_id自动识别仓库类型
    
    # RepoProfile提供了以下功能：
    # - 获取Docker容器环境
    # - 获取测试命令
    # - 获取测试文件列表
    # - 解析测试日志
```

### 3. 获取执行环境（Docker容器）

```python
from swesmith.profiles import registry

for task in dataset:
    rp = registry.get_from_inst(task)
    
    # 获取Docker容器，容器已初始化任务实例
    container = rp.get_container(task)
    
    # container 是一个Docker容器对象，可以执行命令
    # 容器中已经checkout到对应的instance_id分支
```

### 4. 创建数据集子集

```python
from datasets import load_dataset

swesmith = load_dataset("SWE-bench/SWE-smith", split="train")

# 定义筛选条件
def criteria(task_instance):
    return (
        ".pr_" in task_instance["instance_id"] and  # 只选择PR镜像生成的实例
        len(task_instance["FAIL_TO_PASS"]) <= 5 and  # F2P测试不超过5个
        len(task_instance["FAIL_TO_PASS"]) >= 2      # F2P测试至少2个
    )

# 筛选实例
subset = [x for x in swesmith if criteria(x)]

# 保存子集
import json
with open("logs/experiments/subset0.json", "w") as f:
    json.dump(subset, f, indent=2)
```

## 数据集生成流程

### 完整工作流

1. **创建执行环境**
   ```bash
   # 构建Docker镜像
   python -m swesmith.build_repo.create_images <repo>
   ```

2. **生成任务实例（Bug）**
   ```bash
   # LM修改方法
   python -m swesmith.bug_gen.llm.modify <repo> \
       --config_file configs/bug_gen/lm_modify.yml \
       --model claude-3-7-sonnet-20250219 \
       --n_bugs 1
   
   # 过程式修改方法
   python -m swesmith.bug_gen.procedural.generate <repo> \
       --max_bugs 10
   
   # PR镜像方法
   python -m swesmith.bug_gen.mirror.generate <file>
   ```

3. **收集补丁**
   ```bash
   python -m swesmith.bug_gen.collect_patches logs/bug_gen/<repo>/
   ```

4. **验证任务实例**
   ```bash
   python -m swesmith.harness.valid \
       logs/bug_gen/<repo>/<repo>_all_patches.json \
       --workers 8
   ```

5. **收集有效实例**
   ```bash
   python -m swesmith.harness.gather logs/run_validation/<run_id>
   ```
   输出：`logs/task_insts/<run_id>.json`

6. **生成问题描述（可选）**
   ```bash
   python -m swesmith.issue_gen.generate \
       --dataset_path logs/task_insts/<run_id>.json \
       --model claude-3-7-sonnet-20250219 \
       --config_file configs/issue_gen/ig_v2.yaml
   ```

## 数据集在训练中的使用

### 1. 生成专家轨迹（Expert Trajectories）

使用 SWE-agent 在数据集实例上生成专家轨迹：

```bash
# 在SWE-agent目录下
./agent/_gen_trajs.sh
```

### 2. 评估轨迹

```bash
python -m swesmith.harness.eval \
    --dataset_path path/to/subset.json \
    --predictions_path path/to/trajectories/<username>/<run_id>/preds.json \
    --run_id <run_id> \
    --workers 10
```

### 3. 转换为训练格式

```bash
python -m swesmith.train.traj_mgr.collect_trajs \
    --traj_dir path/to/trajectories/<username>/<run_id>/ \
    --eval_dir logs/run_evaluation/<run_id>/ \
    --style xml  # 可选: xml, ticks, tool
```

输出格式（JSONL）：
```json
{
  "messages": [
    {"role": "system", "content": "..."},
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."}
  ],
  "instance_id": "...",
  "resolved": true,
  "traj_id": "...",
  "patch": "..."
}
```

### 4. 训练模型

使用转换后的轨迹文件进行微调：

```python
# 示例：使用unsloth进行训练
from datasets import Dataset
import json

# 加载数据
with open("trajectories_sft/ft_xml_*.jsonl") as f:
    dataset = [json.loads(line) for line in f]

dataset = [D["messages"] for D in dataset]
dataset = Dataset.from_dict({"conversations": dataset})
```

## 数据集评估

### 评估预测结果

```bash
python -m swesmith.harness.eval \
    --dataset_path logs/task_insts/<run_id>.json \
    --predictions_path path/to/predictions.json \
    --run_id <run_id> \
    --workers 10
```

预测文件格式：
```json
{
  "instance_id": "...",
  "patch": "...",
  "model_name_or_path": "..."
}
```

### 使用黄金标准评估

```bash
python -m swesmith.harness.eval \
    --dataset_path logs/task_insts/<run_id>.json \
    --predictions_path gold \
    --run_id sanity_check
```

## 关键常量和工具

### 常量定义（`swesmith/constants.py`）

```python
HF_DATASET = "SWE-bench/SWE-smith"      # HuggingFace数据集名称
KEY_INSTANCE_ID = "instance_id"          # 实例ID键
KEY_PATCH = "patch"                      # 补丁键
KEY_IMAGE_NAME = "image_name"            # 镜像名称键
FAIL_TO_PASS = "FAIL_TO_PASS"           # 失败测试键
PASS_TO_PASS = "PASS_TO_PASS"           # 通过测试键
```

### RepoProfile 注册表

```python
from swesmith.profiles import registry

# 获取所有已注册的profile
profiles = registry.values()

# 根据仓库名称获取profile
profile = registry.get("owner__repo.commit")

# 从实例获取profile
profile = registry.get_from_inst(instance)
```

## 数据集特点

1. **多语言支持**: Python, Go, Rust, Java, JavaScript, C/C++, C#, PHP, Ruby
2. **多种生成方法**: LM生成、过程式修改、PR镜像
3. **完整验证**: 包含F2P和P2P测试用例
4. **Docker隔离**: 每个仓库有独立的执行环境
5. **可扩展**: 可以轻松添加新的仓库和生成方法

## 注意事项

1. **Docker要求**: SWE-smith 需要 Docker 来创建执行环境
2. **GitHub认证**: 某些操作需要 GitHub token（环境变量 `GITHUB_TOKEN`）
3. **数据格式**: 确保数据集实例包含必需的字段（instance_id, patch, FAIL_TO_PASS, PASS_TO_PASS）
4. **镜像拉取**: 首次使用需要拉取或构建Docker镜像
5. **分支管理**: gather 操作会在GitHub上创建分支，需要适当的权限

## 相关资源

- **数据集**: https://huggingface.co/datasets/SWE-bench/SWE-smith
- **轨迹数据**: https://huggingface.co/datasets/SWE-bench/SWE-smith-trajectories
- **预训练模型**: https://huggingface.co/SWE-bench/SWE-agent-LM-32B
- **环境镜像**: https://github.com/SWE-bench/SWE-smith-envs
- **文档**: https://swesmith.com/

